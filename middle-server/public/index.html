<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CloudClaw Dashboard</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      background: #0d1117;
      color: #e6edf3;
    }
    h1 { margin-bottom: 0.5rem; }
    .subtitle { color: #8b949e; margin-bottom: 2rem; }
    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .card h2 { margin-top: 0; display: flex; align-items: center; gap: 0.5rem; }
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
    }
    button:hover { background: #2ea043; }
    button:disabled { background: #30363d; cursor: not-allowed; }
    button.secondary { background: #21262d; border: 1px solid #30363d; }
    button.secondary:hover { background: #30363d; }
    button.danger { background: #da3633; }
    button.danger:hover { background: #f85149; }
    
    /* Machine styles */
    .machine-list { display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0; }
    .machine-item {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }
    .machine-item.selected { border-color: #238636; background: #0d1117; }
    .machine-name { font-weight: 500; }
    .machine-host { color: #8b949e; font-family: monospace; font-size: 0.75rem; }
    
    /* Instance styles */
    .instance-list { margin-top: 1rem; }
    .instance-item {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      margin-bottom: 0.75rem;
      overflow: hidden;
    }
    .instance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      cursor: pointer;
    }
    .instance-header:hover { background: #161b22; }
    .instance-info { flex: 1; }
    .instance-name { 
      font-family: monospace; 
      font-size: 1.1rem;
      color: #58a6ff; 
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .instance-name .emoji { font-size: 1.3rem; }
    .instance-meta { color: #8b949e; font-size: 0.875rem; margin-top: 0.25rem; }
    .instance-actions { display: flex; gap: 0.5rem; }
    .instance-sessions {
      border-top: 1px solid #30363d;
      padding: 1rem;
      background: #0d1117;
      display: none;
    }
    .instance-sessions.expanded { display: block; }
    
    /* Session styles */
    .session-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }
    .session-info { flex: 1; }
    .session-id { font-family: monospace; color: #7ee787; font-size: 0.875rem; }
    .session-expires { color: #8b949e; font-size: 0.75rem; }
    .session-actions { display: flex; gap: 0.5rem; }
    .session-actions button { padding: 0.4rem 0.75rem; font-size: 0.75rem; }
    
    .status {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status.running, .status.connected { background: #238636; }
    .status.pending, .status.unknown { background: #9e6a03; }
    .status.stopped, .status.error { background: #da3633; }
    .empty { color: #8b949e; font-style: italic; padding: 1rem; text-align: center; }
    
    /* Tunnel styles */
    .session-tunnels { margin-top: 0.5rem; }
    .tunnel-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
      font-size: 0.875rem;
    }
    .tunnel-port {
      background: #238636;
      color: white;
      padding: 0.1rem 0.4rem;
      border-radius: 3px;
      font-family: monospace;
    }
    .tunnel-url {
      color: #58a6ff;
      text-decoration: none;
      font-family: monospace;
      font-size: 0.75rem;
    }
    .tunnel-url:hover { text-decoration: underline; }
    .tunnel-close {
      background: transparent;
      border: none;
      color: #8b949e;
      cursor: pointer;
      padding: 0.1rem 0.3rem;
      font-size: 0.75rem;
    }
    .tunnel-close:hover { color: #da3633; background: transparent; }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 2rem;
      width: 500px;
      max-width: 90%;
    }
    .modal-content h3 { margin-top: 0; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; color: #8b949e; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      background: #0d1117;
      border: 1px solid #30363d;
      color: #e6edf3;
      padding: 0.5rem;
      border-radius: 4px;
      font-family: inherit;
    }
    .form-group textarea { min-height: 100px; font-family: monospace; }
    .form-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem; }
    
    #runner-status { margin-left: auto; }
  </style>
</head>
<body>
  <h1>ü¶Ä CloudClaw Dashboard</h1>
  <p class="subtitle">Manage your OpenClaw fleet</p>

  <!-- Machines Card -->
  <div class="card">
    <h2>üñ•Ô∏è Machines</h2>
    <div id="machines-list" class="machine-list">
      Loading...
    </div>
    <button onclick="showAddMachineModal()">+ Add Remote Machine</button>
  </div>

  <!-- Instances Card -->
  <div class="card">
    <h2>
      ü¶Ä Instances
      <span id="runner-status"></span>
    </h2>
    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
      <button onclick="createInstance()">+ Deploy New Instance</button>
      <select id="deploy-machine" style="background: #0d1117; border: 1px solid #30363d; color: #e6edf3; padding: 0.5rem; border-radius: 4px;">
        <option value="">on localhost</option>
      </select>
    </div>
    <div id="instances-list" class="instance-list">
      <p class="empty">No instances yet. Deploy one to get started!</p>
    </div>
  </div>

  <!-- Add Machine Modal -->
  <div id="add-machine-modal" class="modal">
    <div class="modal-content">
      <h3>Add Remote Machine</h3>
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="machine-name" placeholder="my-server">
      </div>
      <div class="form-group">
        <label>Host</label>
        <input type="text" id="machine-host" placeholder="192.168.1.100 or hostname">
      </div>
      <div class="form-group">
        <label>SSH Port</label>
        <input type="number" id="machine-port" value="22">
      </div>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="machine-username" value="root">
      </div>
      <div class="form-group">
        <label>Auth Type</label>
        <select id="machine-auth-type" onchange="toggleAuthFields()">
          <option value="key">SSH Key</option>
          <option value="password">Password</option>
        </select>
      </div>
      <div class="form-group" id="ssh-key-group">
        <label>SSH Private Key</label>
        <textarea id="machine-ssh-key" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----
...
-----END OPENSSH PRIVATE KEY-----"></textarea>
      </div>
      <div class="form-group" id="password-group" style="display: none;">
        <label>Password</label>
        <input type="password" id="machine-password">
      </div>
      <div class="form-group">
        <label>Runner Port (on remote machine)</label>
        <input type="number" id="machine-runner-port" value="8080">
      </div>
      <div class="form-actions">
        <button class="secondary" onclick="hideAddMachineModal()">Cancel</button>
        <button onclick="addMachine()">Add Machine</button>
      </div>
    </div>
  </div>

  <script>
    const expandedInstances = new Set();
    let selectedMachine = 'localhost';

    // ============ MACHINES ============
    
    async function loadMachines() {
      try {
        const res = await fetch('/api/machines');
        const data = await res.json();
        const list = document.getElementById('machines-list');
        const select = document.getElementById('deploy-machine');
        
        list.innerHTML = data.machines.map(m => `
          <div class="machine-item ${m.name === selectedMachine ? 'selected' : ''}" onclick="selectMachine('${m.name}')">
            <span>${m.isLocal ? 'üè†' : '‚òÅÔ∏è'}</span>
            <span class="machine-name">${m.name}</span>
            <span class="machine-host">${m.host}${m.port !== 22 ? ':' + m.port : ''}</span>
            <span class="status ${m.status}">${m.status}</span>
            ${!m.isLocal ? `<button class="danger" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;" onclick="event.stopPropagation(); deleteMachine('${m.id}', '${m.name}')">‚úï</button>` : ''}
          </div>
        `).join('');

        select.innerHTML = data.machines.map(m => 
          `<option value="${m.id}" ${m.name === selectedMachine ? 'selected' : ''}>on ${m.name}</option>`
        ).join('');
      } catch (err) {
        console.error('Failed to load machines:', err);
      }
    }

    function selectMachine(name) {
      selectedMachine = name;
      loadMachines();
    }

    function showAddMachineModal() {
      document.getElementById('add-machine-modal').classList.add('active');
    }

    function hideAddMachineModal() {
      document.getElementById('add-machine-modal').classList.remove('active');
      // Clear form
      document.getElementById('machine-name').value = '';
      document.getElementById('machine-host').value = '';
      document.getElementById('machine-ssh-key').value = '';
      document.getElementById('machine-password').value = '';
    }

    function toggleAuthFields() {
      const authType = document.getElementById('machine-auth-type').value;
      document.getElementById('ssh-key-group').style.display = authType === 'key' ? 'block' : 'none';
      document.getElementById('password-group').style.display = authType === 'password' ? 'block' : 'none';
    }

    async function addMachine() {
      const name = document.getElementById('machine-name').value.trim();
      const host = document.getElementById('machine-host').value.trim();
      const port = parseInt(document.getElementById('machine-port').value) || 22;
      const username = document.getElementById('machine-username').value.trim() || 'root';
      const authType = document.getElementById('machine-auth-type').value;
      const sshKey = document.getElementById('machine-ssh-key').value.trim();
      const password = document.getElementById('machine-password').value;
      const runnerPort = parseInt(document.getElementById('machine-runner-port').value) || 8080;

      if (!name || !host) {
        alert('Name and host are required');
        return;
      }

      try {
        const res = await fetch('/api/machines', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, host, port, username, authType, sshKey, password, runnerPort })
        });

        const data = await res.json();
        if (res.ok) {
          hideAddMachineModal();
          loadMachines();
          
          // Test the connection
          const testRes = await fetch(`/api/machines/${data.id}/test`, { method: 'POST' });
          const testData = await testRes.json();
          if (testData.success) {
            alert(`Machine added and connected!`);
          } else {
            alert(`Machine added but connection failed: ${testData.error}`);
          }
          loadMachines();
        } else {
          alert('Failed to add machine: ' + data.error);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function deleteMachine(id, name) {
      if (!confirm(`Delete machine "${name}"?`)) return;
      
      try {
        await fetch(`/api/machines/${id}`, { method: 'DELETE' });
        loadMachines();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ============ INSTANCES ============

    async function checkHealth() {
      const el = document.getElementById('runner-status');
      try {
        const res = await fetch('/api/health');
        const data = await res.json();
        if (data.runner?.status === 'ok') {
          el.innerHTML = '<span class="status running">Local Runner: Connected</span>';
        } else {
          el.innerHTML = '<span class="status error">Local Runner: ' + (data.runner?.error || 'Disconnected') + '</span>';
        }
      } catch (err) {
        el.innerHTML = '<span class="status error">Health check failed</span>';
      }
    }

    async function loadInstances() {
      try {
        const res = await fetch('/api/instances');
        const data = await res.json();
        const list = document.getElementById('instances-list');
        
        if (data.instances.length === 0) {
          list.innerHTML = '<p class="empty">No instances yet. Deploy one to get started!</p>';
          return;
        }

        list.innerHTML = data.instances.map(inst => {
          const machineName = inst.config?.machineName || 'localhost';
          return `
          <div class="instance-item" id="instance-${inst.id}">
            <div class="instance-header" onclick="toggleInstance('${inst.id}')">
              <div class="instance-info">
                <div class="instance-name">
                  <span class="emoji">ü¶Ä</span>
                  ${inst.name}
                  <span class="status ${inst.status}">${inst.status}</span>
                </div>
                <div class="instance-meta">
                  ${machineName} ‚Ä¢ ${inst.ipAddress || 'localhost'} ‚Ä¢ Created ${new Date(inst.createdAt).toLocaleString()}
                </div>
              </div>
              <div class="instance-actions">
                <button class="secondary" onclick="event.stopPropagation(); createSessionOnInstance('${inst.id}', '${inst.name}')">+ Session</button>
                <button class="danger" onclick="event.stopPropagation(); deleteInstance('${inst.id}', '${inst.name}')">Delete</button>
              </div>
            </div>
            <div class="instance-sessions ${expandedInstances.has(inst.id) ? 'expanded' : ''}" id="sessions-${inst.id}">
              <div id="session-list-${inst.id}">Loading sessions...</div>
            </div>
          </div>
        `}).join('');

        data.instances.forEach(inst => {
          if (expandedInstances.has(inst.id)) {
            loadSessionsForInstance(inst.id);
          }
        });
      } catch (err) {
        console.error('Failed to load instances:', err);
      }
    }

    function toggleInstance(instanceId) {
      const sessionsEl = document.getElementById(`sessions-${instanceId}`);
      if (sessionsEl.classList.contains('expanded')) {
        sessionsEl.classList.remove('expanded');
        expandedInstances.delete(instanceId);
      } else {
        sessionsEl.classList.add('expanded');
        expandedInstances.add(instanceId);
        loadSessionsForInstance(instanceId);
      }
    }

    async function loadSessionsForInstance(instanceId) {
      try {
        const res = await fetch(`/api/instances/${instanceId}/sessions`);
        const data = await res.json();
        const list = document.getElementById(`session-list-${instanceId}`);
        
        if (!data.sessions || data.sessions.length === 0) {
          list.innerHTML = '<p class="empty">No active sessions</p>';
          return;
        }

        list.innerHTML = data.sessions.map(s => `
          <div class="session-item">
            <div class="session-info">
              <div class="session-id">${s.sessionId.substring(0, 8)}...</div>
              <div class="session-expires">Expires: ${new Date(s.expiresAt).toLocaleTimeString()}</div>
              <div class="session-tunnels" id="tunnels-${s.sessionId}"></div>
            </div>
            <div class="session-actions">
              <button onclick="launchChrome('${s.sessionId}')">üåê</button>
              <button onclick="createTunnel('${s.sessionId}')">üîó</button>
              <button onclick="openViewer('${s.sessionId}')">üëÅ</button>
              <button class="danger" onclick="stopSession('${s.sessionId}', '${instanceId}')">‚úï</button>
            </div>
          </div>
        `).join('');

        data.sessions.forEach(s => loadTunnels(s.sessionId));
      } catch (err) {
        console.error('Failed to load sessions:', err);
      }
    }

    async function createInstance() {
      const machineId = document.getElementById('deploy-machine').value;
      
      try {
        const res = await fetch('/api/instances', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ machineId: machineId || undefined })
        });
        
        const data = await res.json();
        if (res.ok) {
          expandedInstances.add(data.id);
          loadInstances();
        } else {
          alert('Failed to create instance: ' + data.error);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function deleteInstance(instanceId, name) {
      if (!confirm(`Delete instance "${name}"? This will stop all sessions.`)) return;
      
      try {
        await fetch(`/api/instances/${instanceId}`, { method: 'DELETE' });
        expandedInstances.delete(instanceId);
        loadInstances();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function createSessionOnInstance(instanceId, instanceName) {
      try {
        const res = await fetch(`/api/instances/${instanceId}/sessions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ width: 1280, height: 720, ttl_seconds: 900 })
        });

        const data = await res.json();
        if (res.ok) {
          expandedInstances.add(instanceId);
          loadInstances();
          window.open(data.view_url, '_blank');
        } else {
          alert('Failed to create session: ' + data.error);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function openViewer(sessionId) {
      window.open(`/sessions/${sessionId}/view`, '_blank');
    }

    async function stopSession(sessionId, instanceId) {
      if (!confirm('Stop this session?')) return;
      
      try {
        await fetch(`/api/sessions/${sessionId}/stop`, { method: 'POST' });
        loadSessionsForInstance(instanceId);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function launchChrome(sessionId) {
      const url = prompt('Enter URL to open:', 'https://google.com');
      if (!url) return;

      try {
        const res = await fetch(`/api/sessions/${sessionId}/chrome`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        if (res.ok) {
          window.open(`/sessions/${sessionId}/view`, '_blank');
        } else {
          const data = await res.json();
          alert('Failed to launch Chrome: ' + data.error);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function createTunnel(sessionId) {
      const port = prompt('Enter local port to share:', '3000');
      if (!port) return;

      const portNum = parseInt(port);
      if (isNaN(portNum) || portNum < 1 || portNum > 65535) {
        alert('Invalid port number');
        return;
      }

      try {
        const res = await fetch(`/api/sessions/${sessionId}/tunnels`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ port: portNum })
        });

        const data = await res.json();
        if (res.ok) {
          loadTunnels(sessionId);
          navigator.clipboard.writeText(data.url);
          alert(`Tunnel created!\\n\\nURL: ${data.url}\\n\\n(Copied to clipboard)`);
        } else {
          alert('Failed to create tunnel: ' + data.error);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function loadTunnels(sessionId) {
      try {
        const res = await fetch(`/api/sessions/${sessionId}/tunnels`);
        const data = await res.json();
        
        const container = document.getElementById(`tunnels-${sessionId}`);
        if (!container) return;

        if (data.tunnels && data.tunnels.length > 0) {
          container.innerHTML = data.tunnels.map(t => `
            <div class="tunnel-item">
              <span class="tunnel-port">:${t.port}</span>
              <a href="${t.url}" target="_blank" class="tunnel-url">${t.url}</a>
              <button class="tunnel-close" onclick="stopTunnel('${sessionId}', ${t.port})">‚úï</button>
            </div>
          `).join('');
        } else {
          container.innerHTML = '';
        }
      } catch (err) {
        console.error('Failed to load tunnels:', err);
      }
    }

    async function stopTunnel(sessionId, port) {
      try {
        await fetch(`/api/sessions/${sessionId}/tunnels/${port}`, { method: 'DELETE' });
        loadTunnels(sessionId);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Initial load
    checkHealth();
    loadMachines();
    loadInstances();

    // Poll for updates
    setInterval(checkHealth, 10000);
    setInterval(loadMachines, 30000);
    setInterval(loadInstances, 10000);
  </script>
</body>
</html>
