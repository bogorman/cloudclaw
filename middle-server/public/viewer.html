<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CloudClaw Viewer</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      color: #e6edf3;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      background: #161b22;
      border-bottom: 1px solid #30363d;
    }
    .toolbar-left { display: flex; align-items: center; gap: 1rem; }
    .toolbar-right { display: flex; align-items: center; gap: 0.5rem; }
    .logo { font-weight: 600; }
    .status {
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    .status.connected { background: #238636; }
    .status.disconnected { background: #da3633; }
    .status.connecting { background: #9e6a03; }
    button {
      background: #21262d;
      color: #e6edf3;
      border: 1px solid #30363d;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
    }
    button:hover { background: #30363d; }
    button.danger { background: #da3633; border-color: #da3633; }
    button.danger:hover { background: #f85149; }
    #vnc-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #vnc-screen {
      max-width: 100%;
      max-height: 100%;
    }
    .session-id {
      font-family: monospace;
      color: #8b949e;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="toolbar-left">
      <span class="logo">☁️ CloudClaw</span>
      <span id="status" class="status connecting">Connecting...</span>
      <span class="session-id" id="session-id"></span>
    </div>
    <div class="toolbar-right">
      <button onclick="sendCtrlAltDel()">Ctrl+Alt+Del</button>
      <button onclick="toggleFullscreen()">Fullscreen</button>
      <button class="danger" onclick="endSession()">End Session</button>
    </div>
  </div>
  <div id="vnc-container">
    <div id="vnc-screen"></div>
  </div>

  <script type="module">
    // noVNC RFB import from jsDelivr (ES module)
    import RFB from 'https://cdn.jsdelivr.net/npm/@novnc/novnc@1.4.0/core/rfb.js';

    // Extract session ID from URL
    const pathParts = window.location.pathname.split('/');
    const sessionId = pathParts[2];
    document.getElementById('session-id').textContent = sessionId;

    // Build WebSocket URL
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/sessions/${sessionId}/ws`;

    let rfb = null;

    function updateStatus(state) {
      const el = document.getElementById('status');
      el.className = 'status ' + state;
      el.textContent = state.charAt(0).toUpperCase() + state.slice(1);
    }

    window.connect = function connect() {
      updateStatus('connecting');
      
      try {
        rfb = new RFB(
          document.getElementById('vnc-screen'),
          wsUrl,
          {
            scaleViewport: true,
            resizeSession: false,
            qualityLevel: 6,
            compressionLevel: 2
          }
        );

        rfb.addEventListener('connect', () => {
          updateStatus('connected');
          console.log('Connected to VNC');
        });

        rfb.addEventListener('disconnect', (e) => {
          updateStatus('disconnected');
          console.log('Disconnected from VNC:', e.detail);
          
          // Try to reconnect after 3 seconds
          setTimeout(() => {
            if (confirm('Connection lost. Reconnect?')) {
              connect();
            }
          }, 1000);
        });

        rfb.addEventListener('credentialsrequired', () => {
          console.log('Credentials required - not expected with -nopw');
        });

      } catch (err) {
        console.error('Failed to connect:', err);
        updateStatus('disconnected');
      }
    }

    window.sendCtrlAltDel = function() {
      if (rfb) {
        rfb.sendCtrlAltDel();
      }
    }

    window.toggleFullscreen = function() {
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else {
        document.documentElement.requestFullscreen();
      }
    }

    window.endSession = async function() {
      if (!confirm('End this session? The browser will be terminated.')) return;
      
      try {
        await fetch(`/api/sessions/${sessionId}/stop`, { method: 'POST' });
        window.close();
        // If window.close() doesn't work (not opened by script)
        window.location.href = '/';
      } catch (err) {
        alert('Error ending session: ' + err.message);
      }
    }

    // Connect on load
    window.connect();
  </script>
</body>
</html>
